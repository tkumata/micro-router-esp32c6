# IMPROVE IDEA

1. キャプティブポータル機能 (Captive Portal)
   * 現状: ユーザーは AP に接続した後、ブラウザに手動で 192.168.4.1 と入力する必要があります。
   * 改善: AP に接続すると、スマートフォンの OS が自動的に「ログインが必要です」と通知を出し、設定画面を自動で開くようにします（ホテルの Wi-Fi のような挙動）。
   * 必要性: ★★★★★ (必須レベル)
2. mDNS (Multicast DNS) 対応
   * 現状: 設定画面にアクセスするには IP アドレスを覚えている必要があります。
   * 改善: http://micro-router.local のような親しみやすい名前でアクセスできるようにします。
   * 必要性: ★★★★☆
3. 接続クライアント一覧の表示
   * 現状: 「クライアント数: 2」のような数字しか分かりません。
   * 改善: Web UI に、現在接続しているデバイスの MAC アドレスや割り当てられた IP アドレスの一覧を表示します。「誰が繋いでいるか」が分かります。
   * 必要性: ★★★☆☆
4. OTA (Over-The-Air) ファームウェア更新
   * 現状: 機能を追加・修正するたびに USB ケーブルで PC に繋いで書き込む必要があります。
   * 改善: Web ブラウザから新しいファームウェアファイル（.bin）をアップロードして更新できるようにします。ケースに組み込んだ後に非常に便利です。
   * 必要性: ★★★☆☆

## 実装

実装内容のまとめ

### キャプティブポータル機能 (Captive Portal)

動作:

* インターネット接続なし (未設定 or 接続断): 自動的にキャプティブポータルモードが有効になります。この状態で Web 閲覧をしようとすると、強制的にルーターの設定画面 (192.168.4.1) にリダイレクトされます。
* インターネット接続あり: 通常の DNS フィルタリングモードに戻り、広告ブロック機能が動作します。
* メリット: 初回設定時やトラブル時に、ユーザーが IP アドレスを手打ちする手間がなくなります。

変更点:

   * WebUIManager.cpp に server.onNotFound(...) ハンドラを追加しました。

原因の解説:

  1. DNS ハイジャック (実装済み): iOS が captive.apple.com を問い合わせると、ルーターは自分の IP (192.168.4.1) を返します。ここまでは OK です。
  2. HTTP アクセス (不足): 次に iOS は http://captive.apple.com/hotspot-detect.html などの確認用 URL にアクセスしにきます。
  3. 404 エラー: 現状の Web サーバーはトップページ (/) 以外を知らないため、このアクセスに対して 404 Not Found を返してしまいます。iOS はこれを見て「ポータル画面が表示できない」または「インターネットに繋がっている」と誤認してしまいます。

修正策:

Web サーバーに「未知の URL へのアクセスはすべてトップページへ転送する (Catch-All)」という処理を追加します。これにより、どんな URL でアクセスされても設定画面が表示されるようになり、iOS のキャプティブポータル判定が正しく機能します。

iOS や Android が接続確認のために投げる「未知の URL (/hotspot-detect.html など)」へのリクエストを検知し、強制的に http://192.168.4.1/ へリダイレクト（302）するようにしました。 これで、Wi-Fi に接続した直後に iOS の「ログイン」画面が自動的に立ち上がり、設定画面が表示されるはずです。もしこれでも出ない場合は、iOS 側のキャッシュが効いている可能性があるため、一度「ネットワーク設定を削除」してから再接続してみてください。

### mDNS 対応

   * 動作: ブラウザのアドレスバーに http://micro-router.local と入力するだけで設定画面にアクセスできるようになりました。
   * メリット: IP アドレス (192.168.4.1) を覚える必要がなくなりました。
