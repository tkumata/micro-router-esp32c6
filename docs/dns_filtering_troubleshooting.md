# DNS フィルタリング機能のトラブルシューティング

## 問題: 広告ブロックが機能しない

### 診断手順

#### 1. クライアントの DNS サーバー設定を確認

AP に接続したデバイスで、DNS サーバーが `192.168.4.1` になっているか確認してください。

**Windows の場合:**
```cmd
ipconfig /all
```

**macOS の場合:**
```bash
scutil --dns
```

**Linux の場合:**
```bash
cat /etc/resolv.conf
```

**期待される結果:**
```
DNS Servers: 192.168.4.1
```

もし `192.168.4.1` になっていない場合：
- デバイスを再接続してください
- デバイスのネットワーク設定で DNS を手動で `192.168.4.1` に設定してください

---

#### 2. ESP32C6 のシリアルモニタを確認

Arduino IDE のシリアルモニタ（115200 baud）で以下が表示されているか確認：

```
✅ LittleFS を正常にマウントしました
✅ DNS フィルタを正常に起動しました
✅ DHCP: ESP32C6 を DNS サーバーとして設定（192.168.4.1）
```

---

#### 3. DNS フィルタが有効になっているか確認

Web UI（`http://192.168.4.1/dns-filter`）にアクセスして：
- 「DNS フィルタを有効にする」にチェックが入っているか確認
- チェックが入っていない場合、チェックして「保存」をクリック

---

#### 4. ブロックリストがアップロードされているか確認

Web UI（`http://192.168.4.1/dns-filter`）で：
- 「ブロックリスト登録数」が 0 より大きいか確認
- 0 の場合、ブロックリストをアップロードしてください

**クイックテスト用サンプル:**
```bash
# サンプルブロックリストを使用
# ESP32C6 の Web UI から tools/sample_blocklist.txt をアップロード
```

---

#### 5. DNS クエリが ESP32C6 に届いているか確認

シリアルモニタで DNS クエリのログを確認：

```
DNSFilterManager: 192.168.4.2 からのクエリ: www.google.com
DNSFilterManager: 許可 www.google.com
```

ログが表示されない場合：
- クライアントが ESP32C6 を DNS サーバーとして使用していません
- 手順 1 に戻って DNS 設定を確認してください

---

#### 6. 動作確認テスト

AP に接続したデバイスから以下のコマンドを実行：

**ブロック対象ドメインのテスト:**
```bash
nslookup ads.google.com
```

**期待される結果:**
```
Server:    192.168.4.1
Address:   192.168.4.1#53

Name:      ads.google.com
Address:   0.0.0.0
```

**許可対象ドメインのテスト:**
```bash
nslookup www.google.com
```

**期待される結果:**
```
Server:    192.168.4.1
Address:   192.168.4.1#53

Name:      www.google.com
Address:   142.250.xxx.xxx  (正しい IP アドレス)
```

---

## よくある問題と解決策

### 問題 1: DHCP で DNS サーバーが配布されない

**症状:**
- クライアントの DNS サーバーが `192.168.4.1` にならない

**解決策:**
1. ESP32C6 を再起動
2. クライアントを AP から切断して再接続
3. クライアントのネットワーク設定をリセット（Windows: `ipconfig /release && ipconfig /renew`）

---

### 問題 2: ブロックリストが読み込めない

**症状:**
- シリアルモニタに「ブロックリストファイルが見つかりません」と表示される

**解決策:**
1. Web UI から `tools/sample_blocklist.txt` をアップロード
2. または豆腐フィルタから変換した `domain.txt` をアップロード

---

### 問題 3: 一部のサイトがブロックされない

**症状:**
- 広告が表示される

**原因:**
- ブロックリストにそのドメインが含まれていない
- HTTPS 証明書のドメイン名が異なる

**解決策:**
1. シリアルモニタで「許可」されたドメインを確認
2. 必要に応じてそのドメインをブロックリストに追加
3. より包括的なブロックリスト（豆腐フィルタなど）を使用

---

### 問題 4: インターネット接続が遅くなった

**症状:**
- Web ページの読み込みが遅い

**原因:**
- DNS クエリの処理オーバーヘッド
- 上流 DNS サーバーへの転送遅延

**解決策:**
1. ブロックリストのサイズを削減（推奨: 500〜1,000 ドメイン）
2. 必要に応じて DNS フィルタを無効化

---

## デバッグ用コマンド

### DNS クエリのテスト

```bash
# Windows
nslookup ads.google.com 192.168.4.1

# macOS/Linux
dig @192.168.4.1 ads.google.com
```

### HTTP リクエストのテスト

```bash
# ブロック対象（接続失敗が期待される）
curl -I http://ads.google.com

# 許可対象（200 OK が期待される）
curl -I http://www.google.com
```

---

## 統計情報の確認

Web UI（`http://192.168.4.1/dns-filter`）で：
- 総クエリ数
- ブロック数とパーセンテージ
- 許可数とパーセンテージ

を確認して、DNS フィルタが正常に動作しているかチェックできます。
